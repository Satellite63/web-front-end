<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidro-Tec - Gerenciamento de Estoque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --navbar-bg-color: #B7BFAF;
            --navbar-text-color: #212529;
            --logo-height: 100px;
            --user-font-size: 1.1rem;
            --farm-name-font-size: 1.8rem;
            --btn-adicionar-color: #63d003;
            --btn-remover-color: #b11804;
            --btn-editar-color: #F68300;
        }
        
        body {
            background-color: #CED0CC;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .custom-navbar {
            background-color: var(--navbar-bg-color) !important;
            color: var(--navbar-text-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
        }
        
        .action-bar {
            background-color: #CED0CC;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 8px 20px;
            margin: 0 5px;
            border-radius: 5px;
            font-weight: 600;
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0.9;
        }
        
        .btn-adicionar {
            background-color: var(--btn-adicionar-color);
        }
        
        .btn-remover {
            background-color: var(--btn-remover-color);
        }
        
        .btn-editar {
            background-color: var(--btn-editar-color);
        }

        .custom-navbar .navbar-brand img {
            height: var(--logo-height);
            transition: all 0.3s ease;
        }
        
        .farm-name {
            font-size: var(--farm-name-font-size);
            font-weight: 700;
            color: #2c3e50;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .user-area {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .user-name {
            font-size: var(--user-font-size);
            font-weight: 800;
            margin-left: 10px;
            color: #2c3e50;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos para os modais */
        .modal-form .form-group {
            margin-bottom: 1rem;
        }
        
        .modal-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .modal-form input, 
        .modal-form select,
        .modal-form textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        
        /* Estilo para a lista de produtos */
        .products-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .product-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .valor-real {
            color: #28a745;
            font-weight: bold;
        }

        .valor-prejuizo {
            color: #dc3545;
            font-weight: bold;
        }

        .product-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #e9ecef;
            font-size: 0.8rem;
            color: #495057;
        }

        /* Estilo específico para a categoria Plantio */
        .product-category-plantio {
            background-color: #8FBC8F;
            color: #fff;
        }

        /* Estilo para o display de estoque */
        #displayEstoque {
            margin-bottom: 20px;
        }

        #displayEstoque .alert {
            margin-bottom: 0;
        }
        
        /* Estilos para o filtro */
        .filtro-container {
            display: flex;
            align-items: center;
        }
        
        .filtro-container label {
            margin-right: 10px;
            margin-bottom: 0;
            font-weight: 600;
        }
        
        .filtro-container select {
            width: auto;
            min-width: 100px;
        }
        
        @media (max-width: 992px) {
            .farm-name {
                position: static;
                transform: none;
                text-align: center;
                width: 100%;
                margin: 10px 0;
                order: 3;
            }
            
            .navbar-collapse {
                flex-direction: column;
            }
            
            .user-area {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .action-bar .d-flex {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                margin: 5px 0;
                width: 80%;
            }
            
            .filtro-container {
                margin-top: 15px;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .filtro-container select {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Barra de navegação -->
    <nav class="navbar navbar-expand-lg navbar-light custom-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="logo_hidrotec.png" alt="Hidro-Tec Logo" class="img-fluid">
            </a>
            
            <div class="farm-name d-none d-lg-block">
                GERENCIAMENTO DE ESTOQUE          
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="farm-name d-lg-none text-center mb-3">
                    GERENCIAMENTO DE ESTOQUE
                </div>
                
                <div class="user-area">
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown">
                            <img src="user.png" alt="Avatar" class="user-avatar">
                            <span class="user-name d-none d-sm-inline">Arthur Vicente</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="home.html"><i class="bi bi-boxes me-2"></i>HOME</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Barra de botões de ação e filtro -->
    <div class="action-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <button class="action-btn btn-adicionar" data-bs-toggle="modal" data-bs-target="#modalAdicionar">
                        <i class="bi bi-plus-circle"></i> ADICIONAR PRODUTO
                    </button>
                    
                    <button class="action-btn btn-editar" data-bs-toggle="modal" data-bs-target="#modalEditar">
                        <i class="bi bi-pencil"></i> EDITAR PRODUTO
                    </button>
                    
                    <button class="action-btn btn-remover" data-bs-toggle="modal" data-bs-target="#modalRemover">
                        <i class="bi bi-trash"></i> REMOVER PRODUTO
                    </button>
                </div>
                
                <div class="filtro-container">
                    <label for="tipoFiltroData">Filtrar por:</label>
                    <select id="tipoFiltroData" class="form-select" onchange="atualizarFiltroData()">
                        <option value="entrada">Data de Entrada</option>
                        <option value="validade">Data de Validade</option>
                    </select>

                    <select id="mesFiltro" class="form-select ms-2" onchange="filtrarPorMesAno()">
                        <option value="">Todos meses</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>

                    <select id="anoFiltro" class="form-select ms-2" onchange="filtrarPorMesAno()">
                        <option value="">Todos anos</option>
                        <!-- Os anos serão preenchidos dinamicamente -->
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de produtos -->
    <div class="container products-container">
        <div id="displayEstoque"></div>
        <h4 class="mb-4">Produtos Cadastrados</h4>
        <div id="listaProducts">
            <!-- Os produtos serão inseridos aqui dinamicamente -->
            <p class="text-muted">Nenhum produto cadastrado ainda.</p>
        </div>
    </div>

    <!-- Modal Adicionar -->
    <div class="modal fade" id="modalAdicionar" tabindex="-1" aria-labelledby="modalAdicionarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAdicionarLabel"><i class="bi bi-plus-circle"></i> Adicionar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body modal-form">
                    <form id="formAdicionar">
                        <div class="form-group">
                            <label for="nomeProduct">Nome do Produto:</label>
                            <input type="text" id="nomeProduct" required>
                        </div>
                        <div class="form-group">
                            <label for="categoriaProduct">Categoria:</label>
                            <select id="categoriaProduct" required>
                                <option value="">Selecione uma categoria...</option>
                                <option value="Hidroponia">Hidroponia</option>
                                <option value="Fertilizantes">Fertilizantes</option>
                                <option value="Sementes">Sementes</option>
                                <option value="Equipamentos">Equipamentos</option>
                                <option value="Plantio">Plantio</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group" id="tipoPlantioGroup" style="display: none;">
                            <label for="tipoPlantio">Tipo:</label>
                            <select id="tipoPlantio">
                                <option value="saldo">Saldo</option>
                                <option value="prejuizo">Prejuízo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantidadeProduct">Quantidade em Estoque:</label>
                            <input type="number" id="quantidadeProduct" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="valorProduct">Valor Unitário (R$):</label>
                            <input type="number" id="valorProduct" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="dataEntrada">Data de Entrada:</label>
                            <input type="date" id="dataEntrada" required>
                        </div>
                        <div class="form-group">
                            <label for="dataValidade">Data de Validade (opcional):</label>
                            <input type="date" id="dataValidade">
                        </div>
                        <div class="form-group">
                            <label for="fornecedorProduct">Fornecedor:</label>
                            <input type="text" id="fornecedorProduct">
                        </div>
                        <div class="form-group">
                            <label for="descricaoProduct">Descrição:</label>
                            <textarea id="descricaoProduct" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="adicionarProduct()">Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel"><i class="bi bi-pencil"></i> Editar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body modal-form">
                    <form id="formEditar">
                        <div class="form-group">
                            <label for="productEditar">Selecione o produto:</label>
                            <select id="productEditar" class="form-select" onchange="carregarDadosProduct()" required>
                                <option value="">Selecione um produto...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="novoNomeProduct">Novo Nome:</label>
                            <input type="text" id="novoNomeProduct" required>
                        </div>
                        <div class="form-group">
                            <label for="novaCategoriaProduct">Nova Categoria:</label>
                            <select id="novaCategoriaProduct" required>
                                <option value="">Selecione uma categoria...</option>
                                <option value="Hidroponia">Hidroponia</option>
                                <option value="Fertilizantes">Fertilizantes</option>
                                <option value="Sementes">Sementes</option>
                                <option value="Equipamentos">Equipamentos</option>
                                <option value="Plantio">Plantio</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group" id="novoTipoPlantioGroup" style="display: none;">
                            <label for="novoTipoPlantio">Novo Tipo:</label>
                            <select id="novoTipoPlantio">
                                <option value="saldo">Saldo</option>
                                <option value="prejuizo">Prejuízo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="novaQuantidadeProduct">Nova Quantidade:</label>
                            <input type="number" id="novaQuantidadeProduct" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="novoValorProduct">Novo Valor (R$):</label>
                            <input type="number" id="novoValorProduct" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="novaDataEntrada">Nova Data de Entrada:</label>
                            <input type="date" id="novaDataEntrada" required>
                        </div>
                        <div class="form-group">
                            <label for="novaDataValidade">Nova Data de Validade (opcional):</label>
                            <input type="date" id="novaDataValidade">
                        </div>
                        <div class="form-group">
                            <label for="novoFornecedorProduct">Novo Fornecedor:</label>
                            <input type="text" id="novoFornecedorProduct">
                        </div>
                        <div class="form-group">
                            <label for="novaDescricaoProduct">Nova Descrição:</label>
                            <textarea id="novaDescricaoProduct" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning text-white" onclick="editarProduct()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Remover -->
    <div class="modal fade" id="modalRemover" tabindex="-1" aria-labelledby="modalRemoverLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRemoverLabel"><i class="bi bi-trash"></i> Remover Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body modal-form">
                    <form id="formRemover">
                        <div class="form-group">
                            <label for="productRemover">Selecione o produto para remover:</label>
                            <select id="productRemover" class="form-select" required>
                                <option value="">Selecione um produto...</option>
                            </select>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle"></i> Esta ação não pode ser desfeita!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="removerProduct()">Confirmar Remoção</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inclusão do JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Array para armazenar os produtos
        let products = [];
        
        // Carrega produtos do localStorage ao iniciar
        function carregarProductsDoLocalStorage() {
            const productsSalvos = localStorage.getItem('products');
            if (productsSalvos) {
                products = JSON.parse(productsSalvos);
                atualizarSelectsProducts();
                atualizarListaProducts();
                atualizarDisplayEstoque();
                carregarAnosDisponiveis(); // Carrega os anos disponíveis para o filtro
            }
        }

        // Função para salvar produtos no localStorage
        function salvarProductsNoLocalStorage() {
            localStorage.setItem('products', JSON.stringify(products));
        }
        
        // Função para formatar valor em reais
        function formatarValor(valor) {
            const valorAbsoluto = Math.abs(valor);
            const sinal = valor < 0 ? '-' : '';
            return sinal + 'R$ ' + valorAbsoluto.toFixed(2).replace('.', ',');
        }
        
        // Função para calcular o valor total do estoque
        function calcularValorTotalEstoque() {
            return products.reduce((total, product) => {
                return total + (parseFloat(product.valor) * parseInt(product.quantidade));
             }, 0);
        }

        // Função para calcular o valor total do estoque da categoria Plantio
        function calcularValorTotalPlantio() {
            return products.reduce((total, product) => {
                if (product.categoria === 'Plantio') {
                    return total + (parseFloat(product.valor) * parseInt(product.quantidade));
                }
                return total;
            }, 0);
        }

        // Função para calcular a quantidade total de itens no estoque
        function calcularQuantidadeTotalEstoque() {
            return products.reduce((total, product) => {
                return total + parseInt(product.quantidade);
            }, 0);
        }
        
        // Função para contar produtos por categoria
        function contarProdutosPorCategoria() {
            const categorias = {};
            
            products.forEach(product => {
                if (categorias[product.categoria]) {
                    categorias[product.categoria]++;
                } else {
                    categorias[product.categoria] = 1;
                }
            });
            
            return categorias;
        }
        
        // Função para atualizar o display de estoque
        function atualizarDisplayEstoque() {
            const quantidadeTotal = calcularQuantidadeTotalEstoque();
            const valorTotal = calcularValorTotalEstoque();
            const valorTotalPlantio = calcularValorTotalPlantio();
            const categorias = contarProdutosPorCategoria();
            
            let categoriasHTML = '';
            for (const [categoria, quantidade] of Object.entries(categorias)) {
                categoriasHTML += `<span class="badge bg-secondary me-2">${categoria}: ${quantidade}</span>`;
            }
            
            const displayElement = document.getElementById('displayEstoque');
            
            displayElement.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>Itens no estoque:</strong> ${quantidadeTotal} |
                            <strong>Valor total:</strong> ${formatarValor(valorTotal)}
                            ${valorTotalPlantio !== 0 ? `| <strong>Valor Plantio:</strong> ${formatarValor(valorTotalPlantio)}` : ''}
                        </div>
                        <div>
                            ${categoriasHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Função para atualizar a lista de produtos nos selects
        function atualizarSelectsProducts() {
            const selectEditar = document.getElementById('productEditar');
            const selectRemover = document.getElementById('productRemover');
            
            // Limpar selects
            selectEditar.innerHTML = '<option value="">Selecione um produto...</option>';
            selectRemover.innerHTML = '<option value="">Selecione um produto...</option>';
            
            // Adicionar produtos aos selects
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.nome} (${product.categoria}, Qtd: ${product.quantidade})`;
                
                selectEditar.appendChild(option.cloneNode(true));
                selectRemover.appendChild(option.cloneNode(true));
            });
            
            // Atualizar lista visual e display de estoque
            atualizarListaProducts();
            atualizarDisplayEstoque();
        }
        
        // Função para exibir produtos filtrados
        function exibirProdutosFiltrados(produtosFiltrados) {
            const listaProducts = document.getElementById('listaProducts');
            
            if (produtosFiltrados.length === 0) {
                listaProducts.innerHTML = '<p class="text-muted">Nenhum produto encontrado com os critérios selecionados.</p>';
                return;
            }
            
            listaProducts.innerHTML = '';
            
            // Ordenar produtos por categoria e nome
            const productsOrdenados = [...produtosFiltrados].sort((a, b) => {
                if (a.categoria === b.categoria) {
                    return a.nome.localeCompare(b.nome);
                }
                return a.categoria.localeCompare(b.categoria);
            });
            
            let categoriaAtual = '';
            
            productsOrdenados.forEach(product => {
                // Adicionar cabeçalho de categoria se mudou
                if (product.categoria !== categoriaAtual) {
                    categoriaAtual = product.categoria;
                    const categoriaHeader = document.createElement('h5');
                    categoriaHeader.className = 'mt-3 mb-2 text-muted';
                    categoriaHeader.textContent = categoriaAtual;
                    listaProducts.appendChild(categoriaHeader);
                }
                
                const productElement = document.createElement('div');
                productElement.className = 'product-item';
                
                // Determina a classe CSS com base na categoria
                const categoriaClass = product.categoria === 'Plantio' ? 'product-category-plantio' : 'product-category';
                
                // Determina a classe CSS com base no tipo (para Plantio)
                const valorClass = product.categoria === 'Plantio' && product.tipo === 'prejuizo' ? 'valor-prejuizo' : 'valor-real';
                
                productElement.innerHTML = `
                    <div>
                        <strong>${product.nome}</strong>
                        <span class="${categoriaClass} ms-2">${product.categoria}</span>
                        ${product.categoria === 'Plantio' ? `<small class="ms-2">(${product.tipo})</small>` : ''}
                        <div class="text-muted small">${product.descricao || 'Sem descrição'}</div>
                        <div>
                            <span class="text-muted">Estoque: ${product.quantidade}</span>
                            <span class="${valorClass} ms-2"> - Valor unitário: ${formatarValor(product.valor)}</span>
                        </div>
                        <div class="text-muted small">Fornecedor: ${product.fornecedor || 'Não informado'}</div>
                        <div class="text-muted small">Entrada: ${formatarData(product.dataEntrada)} ${product.dataValidade ? `| Validade: ${formatarData(product.dataValidade)}` : ''}</div>
                    </div>
                    <small class="text-muted">ID: ${product.id}</small>
                `;
                listaProducts.appendChild(productElement);
            });
        }
        
        // Função para formatar data no formato dd/mm/aaaa
        function formatarData(dataString) {
            if (!dataString) return 'Não informada';
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }
        
        // Função para carregar os anos disponíveis nos produtos
        function carregarAnosDisponiveis() {
            const anos = new Set();
            const selectAno = document.getElementById('anoFiltro');
            
            // Limpa as opções, mantendo apenas "Todos anos"
            selectAno.innerHTML = '<option value="">Todos anos</option>';
            
            // Coleta anos únicos das datas de entrada e validade
            products.forEach(product => {
                if (product.dataEntrada) {
                    const anoEntrada = new Date(product.dataEntrada).getFullYear();
                    anos.add(anoEntrada);
                }
                if (product.dataValidade) {
                    const anoValidade = new Date(product.dataValidade).getFullYear();
                    anos.add(anoValidade);
                }
            });
            
            // Ordena os anos e adiciona ao select
            const anosOrdenados = Array.from(anos).sort((a, b) => b - a);
            anosOrdenados.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            });
        }
        
        // Função para filtrar produtos por mês e ano
        function filtrarPorMesAno() {
            const tipoFiltro = document.getElementById('tipoFiltroData').value;
            const mesSelecionado = document.getElementById('mesFiltro').value;
            const anoSelecionado = document.getElementById('anoFiltro').value;
            
            let produtosFiltrados = products;
            
            // Aplica os filtros conforme selecionado
            if (mesSelecionado || anoSelecionado) {
                produtosFiltrados = products.filter(product => {
                    const data = tipoFiltro === 'entrada' ? product.dataEntrada : product.dataValidade;
                    if (!data) return false;
                    
                    const dataObj = new Date(data);
                    const mes = dataObj.getMonth() + 1; // getMonth() retorna 0-11
                    const ano = dataObj.getFullYear();
                    
                    let passaFiltro = true;
                    
                    if (mesSelecionado && mes != mesSelecionado) {
                        passaFiltro = false;
                    }
                    
                    if (anoSelecionado && ano != anoSelecionado) {
                        passaFiltro = false;
                    }
                    
                    return passaFiltro;
                });
            }
            
            exibirProdutosFiltrados(produtosFiltrados);
        }
        
        // Função para atualizar o tipo de filtro (entrada/validade)
        function atualizarFiltroData() {
            filtrarPorMesAno();
        }
        
        // Função para atualizar a lista visual de produtos
        function atualizarListaProducts() {
            filtrarPorMesAno(); // Aplica o filtro atual
        }
        
        // Função para adicionar produto
        function adicionarProduct() {
            const nome = document.getElementById('nomeProduct').value.trim();
            const categoria = document.getElementById('categoriaProduct').value;
            const quantidade = parseInt(document.getElementById('quantidadeProduct').value);
            const valor = parseFloat(document.getElementById('valorProduct').value);
            const dataEntrada = document.getElementById('dataEntrada').value;
            const dataValidade = document.getElementById('dataValidade').value;
            const fornecedor = document.getElementById('fornecedorProduct').value.trim();
            const descricao = document.getElementById('descricaoProduct').value.trim();
            
            // Validação básica
            if (!nome || !categoria || isNaN(quantidade) || isNaN(valor) || !dataEntrada) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Criar novo produto
            const tipo = categoria === 'Plantio' ? document.getElementById('tipoPlantio').value : 'saldo';
            const novoProduct = {
                id: Date.now(), // Usamos o timestamp como ID simples
                nome: nome,
                categoria: categoria,
                quantidade: quantidade,
                valor: tipo === 'prejuizo' ? -Math.abs(valor) : Math.abs(valor),
                dataEntrada: dataEntrada,
                dataValidade: dataValidade || null,
                fornecedor: fornecedor,
                descricao: descricao,
                tipo: tipo
            };
            
            // Adicionar ao array
            products.push(novoProduct);
            
            // Atualizar selects e lista
            atualizarSelectsProducts();
            carregarAnosDisponiveis(); // Atualiza os anos disponíveis
            
            // Salvar no localStorage
            salvarProductsNoLocalStorage();
            
            // Fechar modal e limpar formulário
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAdicionar'));
            modal.hide();
            document.getElementById('formAdicionar').reset();
            
            // Feedback
            alert('Produto adicionado com sucesso!');
        }
        
        // Função para carregar dados do produto selecionado para edição
        function carregarDadosProduct() {
            const productId = parseInt(document.getElementById('productEditar').value);
            if (!productId) return;
            
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('novoNomeProduct').value = product.nome;
                document.getElementById('novaCategoriaProduct').value = product.categoria;
                
                // Mostrar/ocultar campo de tipo
                const novoTipoPlantioGroup = document.getElementById('novoTipoPlantioGroup');
                novoTipoPlantioGroup.style.display = product.categoria === 'Plantio' ? 'block' : 'none';
                
                if (product.categoria === 'Plantio') {
                    document.getElementById('novoTipoPlantio').value = product.tipo;
                }
                
                document.getElementById('novaQuantidadeProduct').value = product.quantidade;
                document.getElementById('novoValorProduct').value = Math.abs(product.valor);
                document.getElementById('novaDataEntrada').value = product.dataEntrada;
                document.getElementById('novaDataValidade').value = product.dataValidade || '';
                document.getElementById('novoFornecedorProduct').value = product.fornecedor || '';
                document.getElementById('novaDescricaoProduct').value = product.descricao || '';
            }
        }
        
        // Função para editar produto
        function editarProduct() {
            const productId = parseInt(document.getElementById('productEditar').value);
            const novoNome = document.getElementById('novoNomeProduct').value.trim();
            const novaCategoria = document.getElementById('novaCategoriaProduct').value;
            const novaQuantidade = parseInt(document.getElementById('novaQuantidadeProduct').value);
            const novoValor = parseFloat(document.getElementById('novoValorProduct').value);
            const novaDataEntrada = document.getElementById('novaDataEntrada').value;
            const novaDataValidade = document.getElementById('novaDataValidade').value;
            const novoFornecedor = document.getElementById('novoFornecedorProduct').value.trim();
            const novaDescricao = document.getElementById('novaDescricaoProduct').value.trim();
            
            // Validação básica
            if (!productId || !novoNome || !novaCategoria || isNaN(novaQuantidade) || isNaN(novoValor) || !novaDataEntrada) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Encontra o produto atual
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            // Determinar o tipo (para Plantio)
            const novoTipo = novaCategoria === 'Plantio' ? document.getElementById('novoTipoPlantio').value : 'saldo';
            const valorFinal = novaCategoria === 'Plantio' && novoTipo === 'prejuizo' ? -Math.abs(novoValor) : Math.abs(novoValor);
            
            // Atualizar o produto
            products[productIndex].nome = novoNome;
            products[productIndex].categoria = novaCategoria;
            products[productIndex].quantidade = novaQuantidade;
            products[productIndex].valor = valorFinal;
            products[productIndex].dataEntrada = novaDataEntrada;
            products[productIndex].dataValidade = novaDataValidade || null;
            products[productIndex].fornecedor = novoFornecedor;
            products[productIndex].descricao = novaDescricao;
            products[productIndex].tipo = novoTipo;
            
            // Atualizar selects e lista
            atualizarSelectsProducts();
            carregarAnosDisponiveis(); // Atualiza os anos disponíveis
            
            // Salvar no localStorage
            salvarProductsNoLocalStorage();
            
            // Fechar modal e limpar formulário
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
            modal.hide();
            document.getElementById('formEditar').reset();
            
            // Feedback
            alert('Produto atualizado com sucesso!');
        }
        
        // Função para remover produto
        function removerProduct() {
            const productId = parseInt(document.getElementById('productRemover').value);
            
            // Validação
            if (!productId) {
                alert('Por favor, selecione um produto para remover!');
                return;
            }
            
            // Confirmação
            if (!confirm('Tem certeza que deseja remover este produto permanentemente?')) {
                return;
            }
            
            // Remover o produto do array
            products = products.filter(p => p.id !== productId);
            
            // Atualizar selects e lista
            atualizarSelectsProducts();
            carregarAnosDisponiveis(); // Atualiza os anos disponíveis
            
            // Salvar no localStorage
            salvarProductsNoLocalStorage();
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalRemover'));
            modal.hide();
            
            // Feedback
            alert('Produto removido com sucesso!');
        }
        
        // Mostrar/ocultar campo de tipo quando a categoria é alterada
        document.getElementById('categoriaProduct').addEventListener('change', function() {
            const tipoPlantioGroup = document.getElementById('tipoPlantioGroup');
            tipoPlantioGroup.style.display = this.value === 'Plantio' ? 'block' : 'none';
        });
        
        document.getElementById('novaCategoriaProduct').addEventListener('change', function() {
            const novoTipoPlantioGroup = document.getElementById('novoTipoPlantioGroup');
            novoTipoPlantioGroup.style.display = this.value === 'Plantio' ? 'block' : 'none';
        });

        // Event listeners para carregar produtos quando os modais são abertos
        document.getElementById('modalEditar').addEventListener('show.bs.modal', function() {
            atualizarSelectsProducts();
        });
        
        document.getElementById('modalRemover').addEventListener('show.bs.modal', function() {
            atualizarSelectsProducts();
        });

        // Carrega os dados ao iniciar a página
        document.addEventListener('DOMContentLoaded', function() {
            carregarProductsDoLocalStorage();
            
            // Define a data de hoje como padrão para o campo de entrada
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataEntrada').value = hoje;
            document.getElementById('novaDataEntrada').value = hoje;
        });
    </script>
</body>
</html>